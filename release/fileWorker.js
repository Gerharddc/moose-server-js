!function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=[];t.Notify=function(e,t,n,i){const o=JSON.stringify({id:t,property:n,status:"notify",systemname:e});r.forEach(e=>{e!==i&&e.send(o)})},t.NotifyError=function(e){const t=JSON.stringify({error:e,status:"error"});r.forEach(e=>{e.send(t)})},t.AddClient=function(e){r.push(e)},t.RemoveClient=function(e){r=r.filter(t=>t!==e)}},function(e,t){e.exports=require("mz/fs")},function(e,t,n){"use strict";(function(e){function r(e,t){return o(this,void 0,void 0,function*(){yield u.setItem("FileTime-"+e,t)})}function i(e){return o(this,void 0,void 0,function*(){return yield u.getItem("FileTime-"+e)})}var o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function c(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=n(1),c=n(7),u=n(8),a=n(0),l=n(3);t.rootPath="/home/printer/",t.readyPath=t.rootPath+"ready/",t.rawPath=t.rootPath+"raw/";let d,f=!1,p=0;t.Init=function(){(d=c.fork(e+"/fileWorker.js")).on("message",e=>o(this,void 0,void 0,function*(){switch(e.type){case"setFileTime":yield r(e.file,e.time);break;case"error":a.NotifyError(e.error);break;case"notifyFiles":a.Notify("Printer",0,"Files",null);break;case"processing":f=e.processing,a.Notify("Printer",0,"Processing",null);break;case"procProg":p=e.procprog,a.Notify("Printer",0,"ProcProg",null)}})),process.on("exit",()=>{d.kill()})},t.getFileTime=i,t.listFiles=function(){return o(this,void 0,void 0,function*(){const e=[];return(yield s.readdir(t.readyPath)).forEach(t=>{e.push(t)}),e})},t.deleteFile=function(e){return o(this,void 0,void 0,function*(){try{yield s.unlink(t.readyPath+e),console.log("Deleted file: "+e),a.Notify("Printer",0,"Files",null)}catch(e){console.log("Error deleting file: "+e)}})},t.getETA=function(e){return o(this,void 0,void 0,function*(){return l.millisToETA((yield i(e))||0)})},t.getProcessing=function(){return f},t.getProcProg=function(){return p}}).call(t,"/")},function(e,t,n){"use strict";function r(e){const t=Math.floor(e/36e5);e-=36e5*t;const n=Math.floor(e/6e4);return e-=6e4*n,`${t}h ${n}m ${Math.round(e/1e3)}s`}function i(e){g=e,T=Math.round(e/m*1e4)/100,v=r(m-e),f.Notify("Printer",0,"Progress",null),f.Notify("Printer",0,"ETA",null)}function o(e){y=e,f.Notify("Printer",0,"Printing",null)}function s(e){P=e,f.Notify("Printer",0,"Paused",null)}var c=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function c(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const u=n(9);class a extends u{emitBedTemp(e){this.emit("BedTemp",e)}emitExtTemp(e){this.emit("ExtTemp",e)}}t.tempUpdateEmitter=new a;const l=n(2),d=n(10),f=n(0),p=[],h=n(11);t.Init=function(){h.OpenPort("/dev/ttyACM0",(e,n)=>{switch(e){case"alltemp":t.tempUpdateEmitter.emitBedTemp(n),t.tempUpdateEmitter.emitExtTemp(n),console.log("temp: "+n);break;case"etemp":t.tempUpdateEmitter.emitExtTemp(n);break;case"btemp":t.tempUpdateEmitter.emitBedTemp(n);break;case"harderror":console.log("Hardware error"),f.NotifyError("Hardware error, firmware shut down");case"unknown":console.log("unknown: "+n)}}),process.on("exit",()=>{h.ClosePort()}),p.push(new d.default(0,"Extruder")),p.push(new d.default(1,"Heatbed",!0)),setInterval(()=>{try{h.RequestTemp()}catch(e){console.log("Temp exception: "+e)}},2e3)},t.SendLine=function(e){h.SendLine(e)},t.getHeater=function(e){for(const t of p)if(t.ID===e)return t;throw new Error("Heater id not found")},t.getHeaterList=function(){const e=[];for(const t of p)e.push(t.ID);return e},t.moveAxis=function(e,t,n,r){h.SendLine("G91");let i=e;n||(i*=-1);let o="G1 ";if(!(["x","y","z","e"].indexOf(r)>-1))throw new Error("Unkown axis: "+r);o+=r.toUpperCase()+i,o+=" F"+60*t,h.SendLine(o)},t.homeAxis=function(e){let t="G28 ";if(["x","y","z"].indexOf(e)>-1)t+=e.toUpperCase();else{if("a"!==e)throw new Error("Unkown axis: "+e);t+="X Y Z"}h.SendLine(t)};let m=0,g=0,y=!1,P=!1,T=50,v="10m 30s";t.millisToETA=r,t.updateTimeLeft=i,t.getPrinting=function(){return y},t.getPaused=function(){return P},t.getProgress=function(){return T},t.getETA=function(){return v},t.printFile=function(e){return c(this,void 0,void 0,function*(){i(m=yield l.getFileTime(e)),h.SendFile(l.readyPath+e,(e,t)=>{"time"===e?i(t):console.log(e+": "+t)}),i(0),o(!0)})},t.pauseFilePrint=function(){h.PausePrint(),s(!0)},t.resumeFilePrint=function(){h.ResumePrint(),s(!1)},t.stopFilePrint=function(){h.StopPrint(),o(!1)},t.donePrint=function(){o(!1)}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";function r(e){process.send&&process.send({error:e,type:"error"})}function i(){process.send&&process.send({type:"notifyFiles"})}function o(e,t){process.send&&process.send({file:e,time:t,type:"setFileTime"})}function s(e){process.send&&process.send({processing:e,type:"processing"})}function c(e){process.send&&process.send({procprog:e,type:"procProg"})}function u(e){return a(this,void 0,void 0,function*(){const t=f.rawPath+e.filename,n=d.parse(e.originalname);let i=f.readyPath+n.name;if(".gcode"!==n.ext)return void r(e.originalname+" is not GCode");let s=1;for(;yield l.exists(i);)s++,i=`${f.readyPath}${n.name}(${s})`;const u=p.TimeFile(t,i,c);o(1===s?n.name:`${n.name}(${s})`,u),yield l.unlink(t),console.log("Filetime: "+u)})}var a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function c(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const l=n(1),d=n(6),f=n(2);process.on("message",e=>{switch(e.action){case"processFile":u(e.file)}});const p=n(12),h=n(13),m=n(14),g=n(15)({dest:f.rawPath}),y=m();y.use(h());try{y.listen(3e3,()=>{console.log("File server listening!")})}catch(e){console.log("Express-listen-error: e")}y.post("/upload",g.single("gcode"),(e,t,n)=>a(this,void 0,void 0,function*(){t.write("ok"),console.log("Upload: "+e.file.filename),s(!0),yield u(e.file),s(!1),i()})),y.post("/uploads",g.array("gcodes"),(e,t,n)=>a(this,void 0,void 0,function*(){if(t.write("ok"),e.files instanceof Array){s(!0);for(const t of e.files)console.log("Upload: "+t.filename),yield u(t);s(!1),i()}}))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("node-persist")},function(e,t){e.exports=require("events")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),i=n(3),o="Heater";class s{constructor(e,t,n=!1){this.targetTemp=100,this.currentTemp=0,this.id=e,this.displayName=t,this.heatbed=n,n?i.tempUpdateEmitter.on("BedTemp",e=>this.updateTemp(e)):i.tempUpdateEmitter.on("ExtTemp",e=>this.updateTemp(e))}get Heatbed(){return this.heatbed}get TargetTemp(){return this.targetTemp}setTargetTemp(e,t){e!==this.TargetTemp&&(this.targetTemp=e,this.sendTemp(),r.Notify(o,this.id,"TargetTemp",t))}get Heating(){return this.heating}setHeating(e,t){e!==this.heating&&(this.heating=e,this.sendTemp(),r.Notify(o,this.id,"Heating",t))}get DisplayName(){return this.displayName}setDisplayName(e,t){e!==this.displayName&&(this.displayName=e,r.Notify(o,this.id,"DisplayName",t))}get CurrentTemp(){return this.currentTemp}get ID(){return this.id}sendTemp(){const e=this.heating?this.targetTemp:-300;this.heatbed?i.SendLine("M140 S"+e):i.SendLine("M104 S"+e)}updateTemp(e){e!==this.currentTemp&&(this.currentTemp=e,r.Notify(o,this.id,"CurrentTemp",null))}}t.default=s},function(e,t,n){(function(e){try{global.process.dlopen(e,"/home/gerhard/Projects/moose-server-js/build/Release/printer.node")}catch(e){throw new Error("Cannot open /home/gerhard/Projects/moose-server-js/build/Release/printer.node: "+e)}}).call(t,n(4)(e))},function(e,t,n){(function(e){try{global.process.dlopen(e,"/home/gerhard/Projects/moose-server-js/build/Release/gcoder.node")}catch(e){throw new Error("Cannot open /home/gerhard/Projects/moose-server-js/build/Release/gcoder.node: "+e)}}).call(t,n(4)(e))},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("multer")}]);