!function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=[];t.Notify=function(e,t,r,o){const i=JSON.stringify({id:t,property:r,status:"notify",systemname:e});n.forEach(e=>{e!==o&&e.send(i)})},t.NotifyError=function(e){const t=JSON.stringify({error:e,status:"error"});n.forEach(e=>{e.send(t)})},t.AddClient=function(e){n.push(e)},t.RemoveClient=function(e){n=n.filter(t=>t!==e)}},function(e,t,r){"use strict";function n(e){const t=Math.floor(e/36e5);e-=36e5*t;const r=Math.floor(e/6e4);return e-=6e4*r,`${t}h ${r}m ${Math.round(e/1e3)}s`}function o(e){m=e,E=Math.round(e/p*1e4)/100,P=n(p-e),d.Notify("Printer",0,"Progress",null),d.Notify("Printer",0,"ETA",null)}function i(e){y=e,d.Notify("Printer",0,"Printing",null)}function s(e){w=e,d.Notify("Printer",0,"Paused",null)}var c=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,c)}a((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const a=r(9);class l extends a{emitBedTemp(e){this.emit("BedTemp",e)}emitExtTemp(e){this.emit("ExtTemp",e)}}t.tempUpdateEmitter=new l;const u=r(2),g=r(10),d=r(0),f=[],h=r(11);t.Init=function(){h.OpenPort("/dev/ttyACM0",(e,r)=>{switch(e){case"alltemp":t.tempUpdateEmitter.emitBedTemp(r),t.tempUpdateEmitter.emitExtTemp(r),console.log("temp: "+r);break;case"etemp":t.tempUpdateEmitter.emitExtTemp(r);break;case"btemp":t.tempUpdateEmitter.emitBedTemp(r);break;case"harderror":console.log("Hardware error"),d.NotifyError("Hardware error, firmware shut down");case"unknown":console.log("unknown: "+r)}}),process.on("exit",()=>{h.ClosePort()}),f.push(new g.default(0,"Extruder")),f.push(new g.default(1,"Heatbed",!0)),setInterval(()=>{try{h.RequestTemp()}catch(e){console.log("Temp exception: "+e)}},2e3)},t.SendLine=function(e){h.SendLine(e)},t.getHeater=function(e){for(const t of f)if(t.ID===e)return t;throw new Error("Heater id not found")},t.getHeaterList=function(){const e=[];for(const t of f)e.push(t.ID);return e},t.moveAxis=function(e,t,r,n){h.SendLine("G91");let o=e;r||(o*=-1);let i="G1 ";if(!(["x","y","z","e"].indexOf(n)>-1))throw new Error("Unkown axis: "+n);i+=n.toUpperCase()+o,i+=" F"+60*t,h.SendLine(i)},t.homeAxis=function(e){let t="G28 ";if(["x","y","z"].indexOf(e)>-1)t+=e.toUpperCase();else{if("a"!==e)throw new Error("Unkown axis: "+e);t+="X Y Z"}h.SendLine(t)};let p=0,m=0,y=!1,w=!1,E=50,P="10m 30s";t.millisToETA=n,t.updateTimeLeft=o,t.getPrinting=function(){return y},t.getPaused=function(){return w},t.getProgress=function(){return E},t.getETA=function(){return P},t.printFile=function(e){return c(this,void 0,void 0,function*(){o(p=yield u.getFileTime(e)),h.SendFile(u.readyPath+e,(e,t)=>{"time"===e?o(t):console.log(e+": "+t)}),o(0),i(!0)})},t.pauseFilePrint=function(){h.PausePrint(),s(!0)},t.resumeFilePrint=function(){h.ResumePrint(),s(!1)},t.stopFilePrint=function(){h.StopPrint(),i(!1)},t.donePrint=function(){i(!1)}},function(e,t,r){"use strict";(function(e){function n(e,t){return i(this,void 0,void 0,function*(){yield a.setItem("FileTime-"+e,t)})}function o(e){return i(this,void 0,void 0,function*(){return yield a.getItem("FileTime-"+e)})}var i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,c)}a((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=r(7),c=r(8),a=r(3),l=r(0),u=r(1);t.rootPath="/home/printer/",t.readyPath=t.rootPath+"ready/",t.rawPath=t.rootPath+"raw/";let g,d=!1,f=0;t.Init=function(){(g=c.fork(e+"/fileWorker.js")).on("message",e=>i(this,void 0,void 0,function*(){switch(e.type){case"setFileTime":yield n(e.file,e.time);break;case"error":l.NotifyError(e.error);break;case"notifyFiles":l.Notify("Printer",0,"Files",null);break;case"processing":d=e.processing,l.Notify("Printer",0,"Processing",null);break;case"procProg":f=e.procprog,l.Notify("Printer",0,"ProcProg",null)}})),process.on("exit",()=>{g.kill()})},t.getFileTime=o,t.listFiles=function(){return i(this,void 0,void 0,function*(){const e=[];return(yield s.readdir(t.readyPath)).forEach(t=>{e.push(t)}),e})},t.deleteFile=function(e){return i(this,void 0,void 0,function*(){try{yield s.unlink(t.readyPath+e),console.log("Deleted file: "+e),l.Notify("Printer",0,"Files",null)}catch(e){console.log("Error deleting file: "+e)}})},t.getETA=function(e){return i(this,void 0,void 0,function*(){return u.millisToETA((yield o(e))||0)})},t.getProcessing=function(){return d},t.getProcProg=function(){return f}}).call(t,"/")},function(e,t){e.exports=require("node-persist")},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,c)}a((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=r(5),i=r(3);process.on("SIGINT",()=>{console.log("\nGracefully shutting down from SIGINT (Ctrl-C)"),process.exit()}),i.initSync();const s=o();s.use(o.static("/home/printer/react")),s.get("*",(e,t)=>{t.sendFile("/home/printer//index.html")}),s.get("/test",(e,t)=>{t.send("Test response!")});try{s.listen(80,()=>{console.log("Example app listening!")})}catch(e){console.log("Express-listen-error: e")}const c=r(6),a=r(0),l=new(r(16).Server)({port:8080});console.log("Started websocket server"),l.on("connection",e=>{a.AddClient(e),console.log("New connection"),e.on("message",t=>n(this,void 0,void 0,function*(){e.send(yield c.HandleRequest(String(t),e))})),e.on("close",(t,r)=>{a.RemoveClient(e),console.log("Connection closed")})});const u=r(2),g=r(1);u.Init(),g.Init()},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(s,c)}a((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=r(2),i=r(1),s=r(13),c={GetTargetTemp:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleGetTargetTemp-Error: no id");try{return i.getHeater(e.id).TargetTemp}catch(e){throw new Error("HandleGetTargetTemp-Error: "+e.message)}},SetTargetTemp:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleSetTargetTemp-Error: no id");if("number"!=typeof e.temp)throw new Error("HandleSetTargetTemp-Error: no temp");try{i.getHeater(e.id).setTargetTemp(e.temp,t)}catch(e){throw new Error("HandleSetTargetTemp-Error: "+e.message)}},GetHeaters:(e,t)=>i.getHeaterList(),GetHeater:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleGetHeater-Error: no id");try{const t=i.getHeater(e.id);return{current:t.CurrentTemp,displayName:t.DisplayName,isOn:t.Heating,target:t.TargetTemp}}catch(e){throw new Error("HandleGetHeater-Error: "+e.message)}},SetHeating:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleSetHeating-Error: no id");if("boolean"!=typeof e.heating)throw new Error("HandleSetHeating-Error: no heating");try{i.getHeater(e.id).setHeating(e.heating,t)}catch(e){throw new Error("HandleGetHeater-Error: "+e.message)}},GetHeating:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleGetHeating-Error: no id");try{return i.getHeater(e.id).Heating}catch(e){throw new Error("HandleGetHeater-Error: "+e.message)}},GetCurrentTemp:(e,t)=>{if("number"!=typeof e.id)throw new Error("HandleGetCurrentTemp-Error: no id");try{return i.getHeater(e.id).CurrentTemp}catch(e){throw new Error("HandleGetHeater-Error: "+e.message)}},ScanWifi:(e,t)=>{try{s.scanWifi()}catch(e){throw new Error("ScanWifi-Error: "+e.message)}},GetSSIDS:(e,t)=>{try{return s.getSSIDS()}catch(e){throw new Error("GetSSIDS-Error: "+e.message)}},GetConnected:(e,t)=>{try{return s.getConnected()}catch(e){throw new Error("GetConnected-Error: "+e.message)}},GetConnectedSSID:(e,t)=>{try{return s.getConnectedSSID()}catch(e){throw new Error("GetConnectedSSID-Error: "+e.message)}},ConnectSSID:(e,t)=>{try{s.connectSSID(e.ssid,e.pwd)}catch(e){throw new Error("ConnectSSID-Error: "+e.message)}},DisconnectWifi:(e,t)=>{try{s.disconnect()}catch(e){throw new Error("DisconnectWifi-Error: "+e.message)}},GetHosting:(e,t)=>{try{return s.getHosting()}catch(e){throw new Error("GetConnectedSSID-Error: "+e.message)}},GetHostingSSID:(e,t)=>{try{return s.getHostingSSID()}catch(e){throw new Error("GetHostingSSID-Error: "+e.message)}},GetHostingPWD:(e,t)=>{try{return s.getHostingPWD()}catch(e){throw new Error("GetHostingPWD-Error: "+e.message)}},StartHosting:(e,t)=>{try{s.startHosting(e.ssid,e.pwd,t)}catch(e){throw new Error("StartHosting-Error: "+e.message)}},StopHosting:(e,t)=>{try{s.stopHosting(t)}catch(e){throw new Error("StartHosting-Error: "+e.message)}},MoveAxis:(e,t)=>{try{i.moveAxis(e.distance,e.speed,e.forward,e.axis)}catch(e){throw new Error("MoveAxis-Error: "+e.message)}},HomeAxis:(e,t)=>{try{i.homeAxis(e.axis)}catch(e){throw new Error("HomeAxis-Error: "+e.message)}},GetFiles:(e,t)=>n(this,void 0,void 0,function*(){try{return yield o.listFiles()}catch(e){throw new Error("GetFiles-Error: "+e.message)}}),PrintFile:(e,t)=>{try{return i.printFile(e.path)}catch(e){throw new Error("PrintFile: "+e.message)}},DeleteFile:(e,t)=>{try{return o.deleteFile(e.path)}catch(e){throw new Error("GetFiles-Error: "+e.message)}},PausePrint:(e,t)=>{try{return i.pauseFilePrint()}catch(e){throw new Error("PausePrint-Error: "+e.message)}},ResumePrint:(e,t)=>{try{return i.resumeFilePrint()}catch(e){throw new Error("ResumePrint-Error: "+e.message)}},StopPrint:(e,t)=>{try{return i.stopFilePrint()}catch(e){throw new Error("StopPrint-Error: "+e.message)}},GetPrinting:(e,t)=>{try{return i.getPrinting()}catch(e){throw new Error("GetPrinting-Error: "+e.message)}},GetPaused:(e,t)=>{try{return i.getPaused()}catch(e){throw new Error("GetPaused-Error: "+e.message)}},GetProgress:(e,t)=>{try{return i.getProgress()}catch(e){throw new Error("GetProgress-Error: "+e.message)}},GetETA:(e,t)=>{try{return i.getETA()}catch(e){throw new Error("GetETA-Error: "+e.message)}},GetFileETA:(e,t)=>n(this,void 0,void 0,function*(){try{return yield o.getETA(e.file)}catch(e){throw new Error("GetFileETA-Error: "+e.message)}}),GetProcessing:(e,t)=>n(this,void 0,void 0,function*(){try{return o.getProcessing()}catch(e){throw new Error("GetProcessing-Error: "+e.message)}}),GetProcProg:(e,t)=>n(this,void 0,void 0,function*(){try{return o.getProcProg()}catch(e){throw new Error("GetProcProg-Error: "+e.message)}})};t.HandleRequest=function(e,t){return n(this,void 0,void 0,function*(){let r;try{const n=JSON.parse(e);if(r=n.id,n.request instanceof String)throw new Error("HandleRequest: no request");if("number"!=typeof n.id)throw new Error("HandleRequest: no id");const o=c[n.request];let i=null;return o?void 0===(i=yield o(n.data,t))&&(i=null):console.log("Unkown request: "+n.request),JSON.stringify({id:n.id,request:n.request,response:i,status:"success"})}catch(e){return JSON.stringify({error:e.message,id:r,status:"error"})}})}},function(e,t){e.exports=require("mz/fs")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("events")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),o=r(1),i="Heater";class s{constructor(e,t,r=!1){this.targetTemp=100,this.currentTemp=0,this.id=e,this.displayName=t,this.heatbed=r,r?o.tempUpdateEmitter.on("BedTemp",e=>this.updateTemp(e)):o.tempUpdateEmitter.on("ExtTemp",e=>this.updateTemp(e))}get Heatbed(){return this.heatbed}get TargetTemp(){return this.targetTemp}setTargetTemp(e,t){e!==this.TargetTemp&&(this.targetTemp=e,this.sendTemp(),n.Notify(i,this.id,"TargetTemp",t))}get Heating(){return this.heating}setHeating(e,t){e!==this.heating&&(this.heating=e,this.sendTemp(),n.Notify(i,this.id,"Heating",t))}get DisplayName(){return this.displayName}setDisplayName(e,t){e!==this.displayName&&(this.displayName=e,n.Notify(i,this.id,"DisplayName",t))}get CurrentTemp(){return this.currentTemp}get ID(){return this.id}sendTemp(){const e=this.heating?this.targetTemp:-300;this.heatbed?o.SendLine("M140 S"+e):o.SendLine("M104 S"+e)}updateTemp(e){e!==this.currentTemp&&(this.currentTemp=e,n.Notify(i,this.id,"CurrentTemp",null))}}t.default=s},function(e,t,r){(function(e){try{global.process.dlopen(e,"/home/gerhard/Projects/moose-server-js/build/Release/printer.node")}catch(e){throw new Error("Cannot open /home/gerhard/Projects/moose-server-js/build/Release/printer.node: "+e)}}).call(t,r(12)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,r){"use strict";function n(e=null){if(!S)throw new Error("Wifi technology not available");console.log("Scanning..."),S.scan(()=>{S.listAccessPoints((t,r)=>{console.log("Got "+r.length+" Access Point(s)"),d.length=0;for(const e of r)d.push({Name:e.Name,Secured:"none"!==e.Security});g.Notify("Wifi",0,"SSIDS",null),e&&e()})})}function o(){f=!1,h=null,g.Notify("Wifi",0,"ConnectedSSID",null),g.Notify("Wifi",0,"Connected",null)}function i(){y&&y.removeListener("PropertyChanged",s),f=!0,h=p,g.Notify("Wifi",0,"ConnectedSSID",null),g.Notify("Wifi",0,"Connected",null)}function s(e,t){if(console.log("Wifi service: "+e+" = "+t),"State"===e)switch(t){case"failure":console.log("Connection failed"),g.NotifyError("Connection failed"),o();break;case"association":console.log("Associating ...");break;case"configuration":console.log("Configuring ...");break;case"online":console.log("Online..."),i();case"ready":console.log("Connected"),i()}}function c(e,t,r){let n=!1;if(e!==E?(E=e,g.Notify("Wifi",0,"HostingSSID",r)):n=!0,t!==P?(P=t,g.Notify("Wifi",0,"HostingPWD",r)):n=!0,!S)throw new Error("Wifi technology not available");w&&S.disableTethering((e,t)=>{e?console.log(e):console.log("Tethering disabled")}),S.enableTethering(E,P,e=>{e?console.log(e):console.log("Tethering enabled")})}function a(e){if(!S)throw new Error("Wifi technology not available");S.disableTethering((e,t)=>{e?console.log(e):console.log("Tethering disabled")})}Object.defineProperty(t,"__esModule",{value:!0});const l=r(14),u=r(15),g=r(0);const d=[];let f=!1,h=null,p=null,m="",y=null,w=!1,E="MooseNet",P="MoosePass";const T=new u(!0);let S=null;T.init(e=>{e instanceof Error?console.log(e.message):((S=T.technologies.WiFi)?(S.setProperty("Powered",!0,()=>{console.log("Enabled wifi")}),S.on("PropertyChanged",(e,t)=>{console.log("Tech prop change: "+e+"="+t),"Connected"===e&&!1===t&&o(),"Tethering"===e&&(w=t,g.Notify("Wifi",0,"Hosting",null))}),S.getProperties((e,t)=>{e?console.log("Get wifi props error: "+e):(t.hasOwnProperty("Connected")&&(f=t.Connected),t.hasOwnProperty("Tethering")&&(w=t.Tethering,t.hasOwnProperty("TetheringIdentifier")&&(E=t.TetheringIdentifier),t.hasOwnProperty("TetheringPassphrase")&&(P=t.TetheringPassphrase)),S&&(f?S.getServices((e,t)=>{console.log("Got services");for(const e in t){const r=t[e];if("ready"===r.State||"online"===r.State)return T.getService(e,(e,t)=>{e?(console.log("Getservice-error: "+e),g.NotifyError("Connection error: "+e)):(y=t,p={Name:r.Name,Secured:"none"!==r.Security},h=p,console.log("Connected to: "+r.Name))}),i(),void setTimeout(()=>n(),500);console.log(e+":"+t[e].State)}g.NotifyError("Could not identify acces point connected to")}):l.series([e=>{w?(console.log("Stopping hosting for scan"),a(),setTimeout(e,500)):e()},e=>{console.log("Scanning"),n(),setTimeout(e,2e3)},e=>{console.log("Starting hosting again"),c(E,P,null)}])))})):console.log("Could not get wifi technology"),T.Agent?(T.Agent.on("Release",()=>{console.log("Connman agent release")}),T.Agent.on("ReportError",(e,t)=>{console.log("Connaman agent ReportError:"),console.log(t)}),T.Agent.on("RequestBrowser",(e,t)=>{console.log("Connman agent RequestBrowser")}),T.Agent.on("RequestInput",(e,t,r)=>{console.log("Connman agent RequestInput: "),console.log(t),"Passphrase"in t&&r({Passphrase:m})}),T.Agent.on("Cancel",()=>{console.log("Connman agent canceled")})):console.log("Error: agent unavailable"))}),t.getSSIDS=function(){return d},t.scanWifi=n,t.connectSSID=function(e,t){if(e===h)return;if(!S)throw new Error("Wifi technology not available");m=t;const r=t=>{t?t.connect?(y=t,p=e,t.on("PropertyChanged",s),t.connect((e,t)=>{e&&(console.log("Wifi connect error: "+e),g.NotifyError("Connection error: "+e),o())})):g.NotifyError("Service is not connectable"):g.NotifyError("No such access point")},i=()=>{S&&S.getServices((t,o)=>{for(const t in o)if(o[t].Name===e.Name)return void T.getService(t,(e,t)=>{e?(console.log("Getservice-error: "+e),g.NotifyError("Connection error: "+e)):(r(t),setTimeout(()=>n(),500))});g.NotifyError("No such access point")})};w?l.series([e=>{console.log("Stopping hosting for connecting"),a(),setTimeout(e,500)},e=>{console.log("Scanning before connect"),n(),setTimeout(e,1e3)},e=>{console.log("Trying to connect"),i(),setTimeout(e,1e3)},e=>{f?console.log("Connection successful"):(console.log("Connection unsuccessful, restarting host"),c(E,P))}]):i()},t.getConnectedSSID=function(){return h},t.getConnected=function(){return f},t.disconnect=function(){y&&y.disconnect(()=>{console.log("Requested disconnect"),setTimeout(()=>{console.log("Restarted host after disconnect"),c(E,P)},1e3)})},t.getHosting=function(){return w},t.getHostingSSID=function(){return E},t.getHostingPWD=function(){return P},t.startHosting=c,t.stopHosting=a},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("connman-node-api")},function(e,t){e.exports=require("ws")}]);